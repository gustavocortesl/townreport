(function(){angular.module("townReportApp",["ngRoute","ngSanitize","ui.bootstrap"]);function e(e,t){e.when("/",{templateUrl:"home/home.view.html",controller:"homeCtrl",controllerAs:"vm"}).when("/about",{templateUrl:"/common/views/genericText.view.html",controller:"aboutCtrl",controllerAs:"vm"}).when("/contact",{templateUrl:"/common/views/genericText.view.html",controller:"contactCtrl",controllerAs:"vm"}).when("/location/:locationid",{templateUrl:"/locationDetail/locationDetail.view.html",controller:"locationDetailCtrl",controllerAs:"vm"}).when("/problem/:problemid",{templateUrl:"/problemDetail/problemDetail.view.html",controller:"problemDetailCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"/auth/register/register.view.html",controller:"registerCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"/auth/login/login.view.html",controller:"loginCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/"});t.html5Mode(true)}angular.module("townReportApp").config(["$routeProvider","$locationProvider",e])})();(function(){angular.module("townReportApp").controller("homeCtrl",e);e.$inject=["$scope","$location","$uibModal","trData","geolocation","authentication"];function e(e,t,o,r,n,a){var l=this;l.pageHeader={title:"TownReport",strapline:"Help local administration to know where the problems are!"};l.sidebar={content:"Looking for wifi and a seat? TownReport helps you find places to work when out and about. Perhaps with coffee, cake or a pint? Let TownReport help you find the place you're looking for."};l.lat=36.74,l.lng=-5.16,l.newMarker=null;l.showAlert=false;l.message="Checking your location...";l.isLoggedIn=a.isLoggedIn();l.currentPath=t.path();var s={zoom:15,center:new google.maps.LatLng(36.74,-5.16),mapTypeId:google.maps.MapTypeId.TERRAIN,minZoom:14};e.map=new google.maps.Map(document.getElementById("map"),s);e.markers=[];var c=new google.maps.InfoWindow;var m=function(t){var o=new google.maps.Marker({map:e.map,position:new google.maps.LatLng(t.lat,t.long),title:t.name,label:t.category.charAt(0)});o.content='<div class="infoWindowContent">'+"<p>"+t.category+"</p>"+"<p>"+t.state+"</p>"+"<p>"+t.desc+"</p>"+"<p>"+t.address+"<p></div>"+'<p><small><a href="/#/problem/'+t.id+'">view details</a></small></p>';google.maps.event.addListener(o,"click",function(){c.setContent('<h4 class="info">'+o.title+"</h4>"+o.content);c.open(e.map,o)});e.markers.push(o);return o};l.setNewMarker=function(t){l.showAlert=true;if(l.newMarker)l.deleteNewMarker();e.map.setCenter(new google.maps.LatLng(l.lat,l.lng));l.newMarker=new google.maps.Marker({map:e.map,zoom:18,position:new google.maps.LatLng(l.lat,l.lng),title:"To register a new Problem, drag this marker\nto the aproximate location and click on it",animation:google.maps.Animation.BOUNCE,draggable:true});google.maps.event.addListener(l.newMarker,"click",function(){l.newMarker.setAnimation(null);l.showAlert=false;l.popupProblemForm()});google.maps.event.addListener(l.newMarker,"drag",function(){l.newMarker.setAnimation(null)})};e.openInfoWindow=function(t,o){t.preventDefault();e.map.setZoom(18);google.maps.event.trigger(o,"click")};l.deleteNewMarker=function(){l.newMarker.setMap(null);l.newMarker=null};l.popupProblemForm=function(){var e=o.open({templateUrl:"/problemModal/problemModal.view.html",controller:"problemModalCtrl as vm",resolve:{newProblemData:function(){return{lat:l.newMarker.getPosition().lat(),lng:l.newMarker.getPosition().lng(),newMarker:l.newMarker,deleteNewMarker:l.deleteNewMarker}}}});e.result.then(function(e){l.deleteNewMarker();e.marker=m({id:e._id,lat:e.lat,long:e.lng,name:e.name,category:e.category,state:e.state,desc:e.description,address:e.address});l.data.problems.push(e);console.log("new problem",e);console.log("new array",l.data.problems)})};l.getData=function(t){l.lat=t.coords.latitude,l.lng=t.coords.longitude;e.map.setCenter(new google.maps.LatLng(l.lat,l.lng));l.message="Searching for nearby problems...";r.problemsByCoords(l.lat,l.lng).success(function(e){l.message=e.length>0?"":"No problems found nearby";l.data={problems:e};for(i=0;i<e.length;i++){e[i].marker=m({id:e[i]._id,lat:e[i].lat,long:e[i].lng,name:e[i].name,category:e[i].category,state:e[i].state,desc:e[i].description,address:e[i].address})}}).error(function(e){l.message="Sorry, something's gone wrong"})};l.showError=function(t){e.$apply(function(){l.message=t.message})};l.noGeo=function(){e.$apply(function(){l.message="Geolocation is not supported by this browser.";e.map.setCenter(new google.maps.LatLng(l.lat,l.lng))})};n.getPosition(l.getData,l.showError,l.noGeo)}})();(function(){angular.module("townReportApp").controller("aboutCtrl",e);function e(){var e=this;e.pageHeader={title:"About TownReport"};e.main={content:"OUR MAIN GOAL: TO GET A BETTER PLACE TO LIVE\n\n"+"TownReport has been created to help local government to know where the problems are. This is achieved with the cooperation of citizens which can report any issue (breakdowns, flaws, etc.) and so alert town maintenance services about it. Those responsible for the maintenance of public facilities can allocate resources and track the progress of works.\n\n"+"The problems to be considered are those related to basic town facilities that can be categorized (electrical-power, water-supply, traffic facilities…). Examples are:\n"+"* An iron manhole cover that makes a noise when a vehicle passes over.\n"+"* A streetlamp with a broken bulb.\n"+"* A public fountain without water.\n"+"* A swing in a playground broken or damaged.\n\n"+"FEATURES\n"+"- The website show in a map the location of registered problems.\n"+"- The website show in a list the main data of registered problems.\n"+"- The problems to show can be filtered by category, state, date, user…\n"+"- Every problem reported have a details page you can open for more information.\n"+"- Citizens can register new problems and see the state of existing ones.\n"+"- Citizens can add comments or more information to any problem reported.\n"}}})();(function(){angular.module("townReportApp").controller("contactCtrl",e);function e(){var e=this;e.pageHeader={title:"Contact Us"};e.main={content:"OUR ADDRESS\n"+"FSWD Capstone Projects\n"+"Muppala Avenue 2016\n"+"40029 Adnor\n"+"Agalam (THE CLOUDSLAND)\n\n"+"PHONE NUMBERS\n"+"899 989 989\n"+"899 987 014\n\n"+"FAX NUMBER\n"+"899 987 015\n\n"+"EMAIL\n"+"contact@fswdcp.com\n"}}})();(function(){angular.module("townReportApp").controller("problemDetailCtrl",e);e.$inject=["$routeParams","$location","$uibModal","trData","authentication"];function e(e,t,o,r,n){var a=this;a.problemid=e.problemid;a.pageHeader={title:a.problemid};r.problemById(a.problemid).success(function(e){a.data={problem:e};a.data.mapsKey="AIzaSyBzMA1nW7Yg65GNj6R3rlIV4Gjch0v8QlE";a.pageHeader={title:a.data.problem.name}}).error(function(e){console.log(e);a.message="Sorry, something's gone wrong"});a.isLoggedIn=n.isLoggedIn();a.currentPath=t.path();a.popupCommentForm=function(){var e=o.open({templateUrl:"/commentModal/commentModal.view.html",controller:"commentModalCtrl as vm",resolve:{problemData:function(){return{problemid:a.problemid,problemName:a.data.problem.name}}}});e.result.then(function(e){a.data.problem.comments.push(e)})};a.popupStateChangeForm=function(){var e=o.open({templateUrl:"/stateChangeModal/stateChangeModal.view.html",controller:"stateChangeModalCtrl as vm",resolve:{problemData:function(){return{problemid:a.problemid,problemName:a.data.problem.name,problemState:a.data.problem.state}}}});e.result.then(function(e){a.data.problem.stateChanges.push(e)})}}})();(function(){angular.module("townReportApp").controller("problemModalCtrl",e);e.$inject=["$uibModalInstance","trData","newProblemData"];function e(e,t,o){var r=this;r.newProblemData=o;r.onSubmit=function(){r.formError="";if(!r.formData||!r.formData.name||!r.formData.category||!r.formData.state||!r.formData.description){r.formError="All fields required, please try again";return false}else{r.doAddProblem(r.newProblemData,r.formData)}};r.doAddProblem=function(e){t.addNewProblem({name:r.formData.name,category:r.formData.category,state:r.formData.state,description:r.formData.description,address:r.formData.address,priority:r.formData.priority,lng:r.newProblemData.lng,lat:r.newProblemData.lat}).success(function(e){r.modal.close(e)}).error(function(e){console.log("Error!");r.formError="Your problem has not been saved, try again"});return false};r.modal={close:function(t){e.close(t)},closeWithoutSave:function(){r.newProblemData.newMarker.setAnimation(google.maps.Animation.BOUNCE);e.dismiss("cancel")},cancel:function(){e.dismiss("cancel");r.newProblemData.deleteNewMarker()}}}})();(function(){angular.module("townReportApp").controller("commentModalCtrl",e);e.$inject=["$uibModalInstance","trData","problemData"];function e(e,t,o){var r=this;r.problemData=o;r.onSubmit=function(){r.formError="";if(!r.formData||!r.formData.commentText){r.formError="Comment text is required, please try again";return false}else{r.doAddComment(r.problemData.problemid,r.formData)}};r.doAddComment=function(e,o){t.addCommentById(e,{commentText:o.commentText}).success(function(e){r.modal.close(e)}).error(function(e){console.log("Error!");r.formError="Your comment has not been saved, try again"});return false};r.modal={close:function(t){e.close(t)},cancel:function(){e.dismiss("cancel")}}}})();(function(){angular.module("townReportApp").controller("stateChangeModalCtrl",e);e.$inject=["$uibModalInstance","trData","problemData"];function e(e,t,o){var r=this;r.problemData=o;r.onSubmit=function(){r.formError="";if(!r.formData||!r.formData.state||!r.formData.commentText){r.formError="All fields required, please try again";return false}else{r.doAddStateChange(r.problemData.problemid,r.formData)}};r.doAddStateChange=function(e,o){t.addStateChangeById(e,{state:o.state,commentText:o.commentText}).success(function(e){r.modal.close(e)}).error(function(e){console.log("Error!");r.formError="State change has not been saved, try again"});return false};r.modal={close:function(t){e.close(t)},cancel:function(){e.dismiss("cancel")}}}})();(function(){angular.module("townReportApp").controller("registerCtrl",e);e.$inject=["$location","authentication"];function e(e,t){var o=this;o.pageHeader={title:"Create a new TownReport account"};o.credentials={name:"",email:"",password:"",password2:""};o.returnPage=e.search().page||"/";o.onSubmit=function(){o.formError="";if(!o.credentials.name||!o.credentials.email||!o.credentials.password||!o.credentials.password2){o.formError="All fields required, please try again";return false}else if(o.credentials.password!==o.credentials.password2){o.formError="Passwords must be the same, please try again";return false}else{o.doRegister()}};o.doRegister=function(){o.formError="";t.register(o.credentials).error(function(e){o.formError=e}).then(function(){e.search("page",null);e.path(o.returnPage)})}}})();(function(){angular.module("townReportApp").controller("loginCtrl",e);e.$inject=["$location","authentication"];function e(e,t){var o=this;o.pageHeader={title:"Sign in to TownReport"};o.credentials={email:"",password:""};o.returnPage=e.search().page||"/";o.onSubmit=function(){o.formError="";if(!o.credentials.email||!o.credentials.password){o.formError="All fields required, please try again";return false}else{o.doLogin()}};o.doLogin=function(){o.formError="";t.login(o.credentials).error(function(e){o.formError=e}).then(function(){e.search("page",null);e.path(o.returnPage)})}}})();(function(){angular.module("townReportApp").service("geolocation",e);function e(){var e=function(e,t,o){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(e,t)}else{o()}};return{getPosition:e}}})();(function(){angular.module("townReportApp").service("trData",e);e.$inject=["$http","authentication"];function e(e,t){var o=function(t,o){return e.get("/api/problems?lng="+o+"&lat="+t+"&maxDistance=100")};var r=function(t){return e.get("/api/problems/"+t)};var n=function(o){return e.post("/api/problems/",o,{headers:{Authorization:"Bearer "+t.getToken()}})};var a=function(o,r){return e.post("/api/problems/"+o+"/comments",r,{headers:{Authorization:"Bearer "+t.getToken()}})};var l=function(o,r){return e.post("/api/problems/"+o+"/statechanges",r,{headers:{Authorization:"Bearer "+t.getToken()}})};return{problemsByCoords:o,problemById:r,addNewProblem:n,addCommentById:a,addStateChangeById:l}}})();(function(){angular.module("townReportApp").service("authentication",e);e.$inject=["$http","$window"];function e(e,t){var o=function(e){t.localStorage["townreport-token"]=e};var r=function(){return t.localStorage["townreport-token"]};var n=function(){var e=r();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return o.exp>Date.now()/1e3}else{return false}};var a=function(){if(n()){var e=r();var o=JSON.parse(t.atob(e.split(".")[1]));return{email:o.email,name:o.name,admin:o.admin}}};var l=function(t){return e.post("/api/register",t).success(function(e){o(e.token)})};var i=function(t){return e.post("/api/login",t).success(function(e){o(e.token)})};var s=function(){t.localStorage.removeItem("townreport-token")};return{saveToken:o,getToken:r,isLoggedIn:n,currentUser:a,register:l,login:i,logout:s}}})();(function(){angular.module("townReportApp").filter("formatDistance",t);var e=function(e){return!isNaN(parseFloat(e))&&isFinite(e)};function t(){return function(t){var o,r;if(t&&e(t)){if(t>1){o=parseFloat(t).toFixed(1);r="km"}else{o=parseInt(t*1e3,10);r="m"}return o+r}else{return"?"}}}})();(function(){angular.module("townReportApp").filter("addHtmlLineBreaks",e);function e(){return function(e){var t=e.replace(/\n/g,"<br/>");return t}}})();(function(){angular.module("townReportApp").filter("customSearch",e);function e(){return function(e,t){var o=[];if(typeof t===undefined||t==="")return e;var r=new RegExp(t,"i");for(var n=0;n<e.length;n++){var a=e[n];if(r.test(a.name)||r.test(a.category)||r.test(a.state)||r.test(a.desc)||r.test(a.address)){o.push(a)}}return o}}})();(function(){angular.module("townReportApp").directive("ratingStars",e);function e(){return{restrict:"EA",scope:{thisRating:"=rating"},templateUrl:"/common/directives/ratingStars/ratingStars.template.html"}}})();(function(){angular.module("townReportApp").directive("footerGeneric",e);function e(){return{restrict:"EA",templateUrl:"/common/directives/footerGeneric/footerGeneric.template.html"}}})();(function(){angular.module("townReportApp").directive("navigation",e);function e(){return{restrict:"EA",templateUrl:"/common/directives/navigation/navigation.template.html",controller:"navigationCtrl as navvm"}}})();(function(){angular.module("townReportApp").controller("navigationCtrl",e);e.$inject=["$location","authentication"];function e(e,t){var o=this;o.currentPath=e.path();o.isLoggedIn=t.isLoggedIn();o.currentUser=t.currentUser();o.logout=function(){t.logout();e.path("/")}}})();(function(){angular.module("townReportApp").directive("pageHeader",e);function e(){return{restrict:"EA",scope:{content:"=content"},templateUrl:"/common/directives/pageHeader/pageHeader.template.html"}}})();