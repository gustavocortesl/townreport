(function(){angular.module("townReportApp",["ngRoute","ngSanitize","ui.bootstrap"]);function e(e,t){e.when("/",{templateUrl:"home/home.view.html",controller:"homeCtrl",controllerAs:"vm"}).when("/about",{templateUrl:"/common/views/genericText.view.html",controller:"aboutCtrl",controllerAs:"vm"}).when("/location/:locationid",{templateUrl:"/locationDetail/locationDetail.view.html",controller:"locationDetailCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"/auth/register/register.view.html",controller:"registerCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"/auth/login/login.view.html",controller:"loginCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/"});t.html5Mode(true)}angular.module("townReportApp").config(["$routeProvider","$locationProvider",e])})();(function(){angular.module("townReportApp").controller("homeCtrl",e);e.$inject=["$scope","trData","geolocation"];function e(e,t,o){var n=this;n.pageHeader={title:"TownReport",strapline:"Help local administration to know where the problems are!"};n.sidebar={content:"Looking for wifi and a seat? TownReport helps you find places to work when out and about. Perhaps with coffee, cake or a pint? Let TownReport help you find the place you're looking for."};n.message="Checking your location";var r={zoom:15,center:new google.maps.LatLng(36.74,-5.16),mapTypeId:google.maps.MapTypeId.TERRAIN};e.map=new google.maps.Map(document.getElementById("map"),r);e.markers=[];var a=new google.maps.InfoWindow;var l=function(t){console.log("info:",t);var o=new google.maps.Marker({map:e.map,position:new google.maps.LatLng(t.lat,t.long),title:t.city});o.content='<div class="infoWindowContent">'+t.desc+"</div>";google.maps.event.addListener(o,"click",function(){a.setContent('<h3 class="info">'+o.title+"</h3>"+o.content);a.open(e.map,o)});e.markers.push(o);return o};e.openInfoWindow=function(e,t){e.preventDefault();google.maps.event.trigger(t,"click")};n.getData=function(e){var o=e.coords.latitude,r=e.coords.longitude;n.message="Searching for nearby places";t.locationByCoords(o,r).success(function(e){n.message=e.length>0?"":"No locations found nearby";n.data={locations:e};for(i=0;i<e.length;i++){e[i].marker=l({lat:e[i].lat,long:e[i].lng,city:e[i].name,desc:e[i].address})}}).error(function(e){n.message="Sorry, something's gone wrong"})};n.showError=function(t){e.$apply(function(){n.message=t.message})};n.noGeo=function(){e.$apply(function(){n.message="Geolocation is not supported by this browser."})};o.getPosition(n.getData,n.showError,n.noGeo)}})();(function(){angular.module("townReportApp").controller("aboutCtrl",e);function e(){var e=this;e.pageHeader={title:"About TownReport"};e.main={content:"TownReport was created to help people report problems.\n\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc sed lorem ac nisi dignissim accumsan.\n\nNullam sit amet interdum magna. Morbi quis faucibus nisi. Vestibulum mollis purus quis eros adipiscing tristique.\n\nProin posuere semper tellus, id placerat augue dapibus ornare. Aenean leo metus, tempus in nisl eget, accumsan interdum dui.\n\nPellentesque sollicitudin volutpat ullamcorper."}}})();(function(){angular.module("townReportApp").controller("locationDetailCtrl",e);e.$inject=["$routeParams","$location","$uibModal","trData","authentication"];function e(e,t,o,n,r){var a=this;a.locationid=e.locationid;a.pageHeader={title:a.locationid};n.locationById(a.locationid).success(function(e){a.data={location:e};a.data.mapsKey="AIzaSyBzMA1nW7Yg65GNj6R3rlIV4Gjch0v8QlE";a.pageHeader={title:a.data.location.name}}).error(function(e){console.log(e);a.message="Sorry, something's gone wrong"});a.isLoggedIn=r.isLoggedIn();a.currentPath=t.path();a.popupReviewForm=function(){var e=o.open({templateUrl:"/reviewModal/reviewModal.view.html",controller:"reviewModalCtrl as vm",resolve:{locationData:function(){return{locationid:a.locationid,locationName:a.data.location.name}}}});e.result.then(function(e){a.data.location.reviews.push(e)})}}})();(function(){angular.module("townReportApp").controller("reviewModalCtrl",e);e.$inject=["$uibModalInstance","trData","locationData"];function e(e,t,o){var n=this;n.locationData=o;n.onSubmit=function(){n.formError="";if(!n.formData||!n.formData.rating||!n.formData.reviewText){n.formError="All fields required, please try again";return false}else{n.doAddReview(n.locationData.locationid,n.formData)}};n.doAddReview=function(e,o){t.addReviewById(e,{rating:o.rating,reviewText:o.reviewText}).success(function(e){n.modal.close(e)}).error(function(e){console.log("Error!");n.formError="Your review has not been saved, try again"});return false};n.modal={close:function(t){e.close(t)},cancel:function(){e.dismiss("cancel")}}}})();(function(){angular.module("townReportApp").controller("registerCtrl",e);e.$inject=["$location","authentication"];function e(e,t){var o=this;o.pageHeader={title:"Create a new TownReport account"};o.credentials={name:"",email:"",password:"",password2:""};o.returnPage=e.search().page||"/";o.onSubmit=function(){o.formError="";if(!o.credentials.name||!o.credentials.email||!o.credentials.password||!o.credentials.password2){o.formError="All fields required, please try again";return false}else if(o.credentials.password!==o.credentials.password2){o.formError="Passwords must be the same, please try again";return false}else{o.doRegister()}};o.doRegister=function(){o.formError="";t.register(o.credentials).error(function(e){o.formError=e}).then(function(){e.search("page",null);e.path(o.returnPage)})}}})();(function(){angular.module("townReportApp").controller("loginCtrl",e);e.$inject=["$location","authentication"];function e(e,t){var o=this;o.pageHeader={title:"Sign in to TownReport"};o.credentials={email:"",password:""};o.returnPage=e.search().page||"/";o.onSubmit=function(){o.formError="";if(!o.credentials.email||!o.credentials.password){o.formError="All fields required, please try again";return false}else{o.doLogin()}};o.doLogin=function(){o.formError="";t.login(o.credentials).error(function(e){o.formError=e}).then(function(){e.search("page",null);e.path(o.returnPage)})}}})();(function(){angular.module("townReportApp").service("geolocation",e);function e(){var e=function(e,t,o){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(e,t)}else{o()}};return{getPosition:e}}})();(function(){angular.module("townReportApp").service("trData",e);e.$inject=["$http","authentication"];function e(e,t){var o=function(t,o){return e.get("/api/locations?lng="+o+"&lat="+t+"&maxDistance=200")};var n=function(t){return e.get("/api/locations/"+t)};var r=function(o,n){return e.post("/api/locations/"+o+"/reviews",n,{headers:{Authorization:"Bearer "+t.getToken()}})};return{locationByCoords:o,locationById:n,addReviewById:r}}})();(function(){angular.module("townReportApp").service("authentication",e);e.$inject=["$http","$window"];function e(e,t){var o=function(e){t.localStorage["townreport-token"]=e};var n=function(){return t.localStorage["townreport-token"]};var r=function(){var e=n();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return o.exp>Date.now()/1e3}else{return false}};var a=function(){if(r()){var e=n();var o=JSON.parse(t.atob(e.split(".")[1]));return{email:o.email,name:o.name}}};var i=function(t){return e.post("/api/register",t).success(function(e){o(e.token)})};var l=function(t){return e.post("/api/login",t).success(function(e){o(e.token)})};var c=function(){t.localStorage.removeItem("townreport-token")};return{saveToken:o,getToken:n,isLoggedIn:r,currentUser:a,register:i,login:l,logout:c}}})();(function(){angular.module("townReportApp").filter("formatDistance",t);var e=function(e){return!isNaN(parseFloat(e))&&isFinite(e)};function t(){return function(t){var o,n;if(t&&e(t)){if(t>1){o=parseFloat(t).toFixed(1);n="km"}else{o=parseInt(t*1e3,10);n="m"}return o+n}else{return"?"}}}})();(function(){angular.module("townReportApp").filter("addHtmlLineBreaks",e);function e(){return function(e){var t=e.replace(/\n/g,"<br/>");return t}}})();(function(){angular.module("townReportApp").directive("ratingStars",e);function e(){return{restrict:"EA",scope:{thisRating:"=rating"},templateUrl:"/common/directives/ratingStars/ratingStars.template.html"}}})();(function(){angular.module("townReportApp").directive("footerGeneric",e);function e(){return{restrict:"EA",templateUrl:"/common/directives/footerGeneric/footerGeneric.template.html"}}})();(function(){angular.module("townReportApp").directive("navigation",e);function e(){return{restrict:"EA",templateUrl:"/common/directives/navigation/navigation.template.html",controller:"navigationCtrl as navvm"}}})();(function(){angular.module("townReportApp").controller("navigationCtrl",e);e.$inject=["$location","authentication"];function e(e,t){var o=this;o.currentPath=e.path();o.isLoggedIn=t.isLoggedIn();o.currentUser=t.currentUser();o.logout=function(){t.logout();e.path("/")}}})();(function(){angular.module("townReportApp").directive("pageHeader",e);function e(){return{restrict:"EA",scope:{content:"=content"},templateUrl:"/common/directives/pageHeader/pageHeader.template.html"}}})();