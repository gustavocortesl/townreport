(function(){angular.module("townReportApp",["ngRoute","ngSanitize","ui.bootstrap"]);function e(e,t){e.when("/",{templateUrl:"home/home.view.html",controller:"homeCtrl",controllerAs:"vm"}).when("/about",{templateUrl:"/common/views/genericText.view.html",controller:"aboutCtrl",controllerAs:"vm"}).when("/contact",{templateUrl:"/common/views/genericText.view.html",controller:"contactCtrl",controllerAs:"vm"}).when("/problem/:problemid",{templateUrl:"/problemDetail/problemDetail.view.html",controller:"problemDetailCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/"});t.html5Mode(true)}angular.module("townReportApp").config(["$routeProvider","$locationProvider",e])})();(function(){angular.module("townReportApp").controller("homeCtrl",e);e.$inject=["$rootScope","$scope","$filter","$location","$uibModal","trData","geolocation","authentication"];function e(e,t,o,n,r,a,l,s){var c=this;c.pageHeader={title:"TownReport",strapline:"Help local administration to know where the problems are!"};c.showAlert=false;c.message="Checking your location...";c.isLoggedIn=s.isLoggedIn();c.isAdmin=s.isAdmin();c.currentPath=n.path();t.$on("$viewContentLoaded",function(){$('[data-toggle="tooltip"]').tooltip()});c.lat=36.74;c.lng=-5.16;var m=new google.maps.LatLngBounds(new google.maps.LatLng(36.72,-5.18),new google.maps.LatLng(36.76,-5.14));var p={zoom:15,center:new google.maps.LatLng(c.lat,c.lng),mapTypeId:google.maps.MapTypeId.TERRAIN,minZoom:13,streetViewControl:false};function u(){t.map=new google.maps.Map(document.getElementById("map"),p);t.heatmap=new google.maps.visualization.HeatmapLayer({data:[],map:null});google.maps.event.addListener(t.map,"dragend",function(){if(m.contains(t.map.getCenter()))return;var e=t.map.getCenter(),o=e.lng(),n=e.lat(),r=m.getNorthEast().lng(),a=m.getNorthEast().lat(),i=m.getSouthWest().lng(),l=m.getSouthWest().lat();if(o>r)o=r;if(o<i)o=i;if(n<l)n=l;if(n>a)n=a;t.map.setCenter(new google.maps.LatLng(n,o))})}t.markers=[];c.newMarker=null;var d=new google.maps.InfoWindow;var g=function(e){var o=new google.maps.Marker({map:t.map,position:new google.maps.LatLng(e.lat,e.lng),title:e.name,label:e.category.charAt(0)});o.content='<div class="infoWindowContent">'+'<div><span class="label label-warning">'+e.category+"</span>"+'<span class="label label-warning">'+e.state+"</span>"+"<p>"+e.desc+"<br>"+e.address+"</p>"+'<p><small class="pull-right"><a href="/#/problem/'+e.id+'">view details</a></small></p></div>';google.maps.event.addListener(o,"click",function(){d.setContent('<h4 class="info">'+o.title+"</h4>"+o.content);d.open(t.map,o)});t.markers.push(o);return o};c.setNewMarker=function(e){c.showAlert=true;if(c.newMarker)c.deleteNewMarker();t.map.setCenter(new google.maps.LatLng(c.lat,c.lng));t.map.setZoom(17);c.newMarker=new google.maps.Marker({map:t.map,zoom:18,position:new google.maps.LatLng(c.lat,c.lng),title:"To register a new Problem, drag this marker\nto the aproximate location and click on it",animation:google.maps.Animation.BOUNCE,draggable:true});google.maps.event.addListener(c.newMarker,"click",function(){c.newMarker.setAnimation(null);c.showAlert=false;c.popupProblemForm()});google.maps.event.addListener(c.newMarker,"drag",function(){c.newMarker.setAnimation(null)})};t.openInfoWindow=function(e,o){e.preventDefault();t.map.setZoom(18);google.maps.event.trigger(o,"click")};c.deleteNewMarker=function(){c.newMarker.setMap(null);c.newMarker=null};c.setMapOnAll=function(e){for(var o=0;o<t.markers.length;o++){t.markers[o].setMap(e)}};c.getPoints=function(e){var t=[];if(e){e.forEach(function(e){t.push(e.position)})}return t};c.toggleHeatmap=function(){if(t.heatmap.getMap()){t.heatmap.setMap(null);c.setMapOnAll(t.map)}else{c.setMapOnAll(null);t.heatmap.setData(c.getPoints(t.markers));t.heatmap.setMap(t.map)}};t.$on("login",function(e){console.log("login homepage",e);c.isLoggedIn=s.isLoggedIn();c.isAdmin=s.isAdmin()});c.callForLoginForm=function(){e.$broadcast("loginRequest","homepage")};c.popupProblemForm=function(){var e=r.open({templateUrl:"/problemModal/problemModal.view.html",controller:"problemModalCtrl as vm",resolve:{newProblemData:function(){return{lat:c.newMarker.getPosition().lat(),lng:c.newMarker.getPosition().lng(),newMarker:c.newMarker,deleteNewMarker:c.deleteNewMarker,isAdmin:c.isAdmin}}}});e.result.then(function(e){c.deleteNewMarker();e.marker=g({id:e._id,lat:e.coords[1],lng:e.coords[0],name:e.name,category:e.category,state:e.state,desc:e.description,address:e.address,priority:e.priority});console.log("data.marker",e.marker);c.data.problems.push(e);google.maps.event.trigger(t.map,"resize");t.map.setZoom(15);console.log("new problem",e)})};t.$watch("textFilter",function(e,n){if(!e)return;var r=o("customSearch")(c.data.problems,e);c.setMapOnAll(null);t.markers=[];for(var a=0;a<r.length;a++){t.markers.push(r[a].marker)}c.setMapOnAll(t.map)});c.getData=function(e){c.lat=e.coords.latitude,c.lng=e.coords.longitude;t.map.setCenter(new google.maps.LatLng(c.lat,c.lng));c.message="Searching for nearby problems...";a.problemsByCoords(c.lat,c.lng).success(function(e){c.message=e.length>0?"":"No problems found nearby";c.data={problems:e};for(i=0;i<e.length;i++){e[i].marker=g({id:e[i]._id,lat:e[i].lat,lng:e[i].lng,name:e[i].name,category:e[i].category,state:e[i].state,desc:e[i].description,address:e[i].address,priority:e[i].priority})}}).error(function(e){c.message="Sorry, something's gone wrong"})};c.showError=function(e){t.$apply(function(){c.message=e.message})};c.noGeo=function(){t.$apply(function(){c.message="Geolocation is not supported by this browser.";t.map.setCenter(new google.maps.LatLng(c.lat,c.lng))})};l.getPosition(c.getData,c.showError,c.noGeo);u()}})();(function(){angular.module("townReportApp").controller("aboutCtrl",e);function e(){var e=this;e.pageHeader={title:"About TownReport"};e.main={content:"OUR MAIN GOAL: TO GET A BETTER PLACE TO LIVE\n\n"+"TownReport has been created to help local government to know where the problems are. This is achieved with the cooperation of citizens which can report any issue (breakdowns, flaws, etc.) and so alert town maintenance services about it. Those responsible for the maintenance of public facilities can allocate resources and track the progress of works.\n\n"+"The problems to be considered are those related to basic town facilities that can be categorized (electrical-power, water-supply, traffic facilities…). Examples are:\n"+"* An iron manhole cover that makes a noise when a vehicle passes over.\n"+"* A streetlamp with a broken bulb.\n"+"* A public fountain without water.\n"+"* A swing in a playground broken or damaged.\n\n"+"FEATURES\n"+"- The website show in a map the location of registered problems.\n"+"- The website show in a list the main data of registered problems.\n"+"- The problems to show can be filtered by category, state, date, user…\n"+"- Every problem reported have a details page you can open for more information.\n"+"- Citizens can register new problems and see the state of existing ones.\n"+"- Citizens can add comments or more information to any problem reported.\n"}}})();(function(){angular.module("townReportApp").controller("contactCtrl",e);function e(){var e=this;e.pageHeader={title:"Contact Us"};e.main={content:"OUR ADDRESS\n"+"FSWD Capstone Projects\n"+"Muppala Avenue 2016\n"+"40029 Adnor\n"+"Agalam (THE CLOUDSLAND)\n\n"+"PHONE NUMBERS\n"+"899 989 989\n"+"899 987 014\n\n"+"FAX NUMBER\n"+"899 987 015\n\n"+"EMAIL\n"+"contact@fswdcp.com\n"}}})();(function(){angular.module("townReportApp").controller("problemDetailCtrl",e);e.$inject=["$rootScope","$scope","$routeParams","$location","$uibModal","trData","authentication"];function e(e,t,o,n,r,a,i){var l=this;l.problemid=o.problemid;l.pageHeader={title:l.problemid};a.problemById(l.problemid).success(function(e){l.data={problem:e};l.data.mapsKey="AIzaSyBzMA1nW7Yg65GNj6R3rlIV4Gjch0v8QlE";l.pageHeader={title:l.data.problem.name}}).error(function(e){console.log(e);l.message="Sorry, something's gone wrong"});l.isLoggedIn=i.isLoggedIn();l.isAdmin=i.isAdmin();l.currentPath=n.path();t.$on("login",function(e){console.log("login detail",e);l.isLoggedIn=i.isLoggedIn();l.isAdmin=i.isAdmin()});l.callForLoginForm=function(){e.$broadcast("loginRequest","homepage")};l.popupCommentForm=function(){var e=r.open({templateUrl:"/commentModal/commentModal.view.html",controller:"commentModalCtrl as vm",resolve:{problemData:function(){return{problemid:l.problemid,problemName:l.data.problem.name}}}});e.result.then(function(e){l.data.problem.comments.push(e)})};l.popupStateChangeForm=function(){var e=r.open({templateUrl:"/stateChangeModal/stateChangeModal.view.html",controller:"stateChangeModalCtrl as vm",resolve:{problemData:function(){return{problemid:l.problemid,problemName:l.data.problem.name,problemState:l.data.problem.state}}}});e.result.then(function(e){l.data.problem.stateChanges.push(e);a.updateProblem(l.problemid,{state:e.state}).success(function(e){l.data.problem.state=e.state}).error(function(e){console.log("Error!");l.formError="Problem state has not been saved"})})}}})();(function(){angular.module("townReportApp").controller("problemModalCtrl",e);e.$inject=["$uibModalInstance","trData","newProblemData"];function e(e,t,o){var n=this;n.newProblemData=o;n.stateOptions=[{name:"New",active:true}];if(n.newProblemData.isAdmin){n.stateOptions.push({name:"Pending",active:true});n.stateOptions.push({name:"Work in progress",active:true});n.stateOptions.push({name:"Fixed",active:true})}n.onSubmit=function(){n.formError="";if(!n.formData||!n.formData.name||!n.formData.category||!n.formData.state||!n.formData.description){n.formError="All fields required, please try again";return false}else{n.doAddProblem(n.newProblemData,n.formData)}};n.doAddProblem=function(e,o){t.addNewProblem({name:o.name,category:o.category,state:o.state.name,description:o.description,address:o.address,priority:o.priority,lng:e.lng,lat:e.lat}).success(function(e){n.modal.close(e)}).error(function(e){console.log("Error!");n.formError="Your problem has not been saved, try again"});return false};n.modal={close:function(t){e.close(t)},closeWithoutSave:function(){n.newProblemData.newMarker.setAnimation(google.maps.Animation.BOUNCE);e.dismiss("cancel")},cancel:function(){e.dismiss("cancel");n.newProblemData.deleteNewMarker()}}}})();(function(){angular.module("townReportApp").controller("commentModalCtrl",e);e.$inject=["$uibModalInstance","trData","problemData"];function e(e,t,o){var n=this;n.problemData=o;n.onSubmit=function(){n.formError="";if(!n.formData||!n.formData.commentText){n.formError="Comment text is required, please try again";return false}else{n.doAddComment(n.problemData.problemid,n.formData)}};n.doAddComment=function(e,o){t.addCommentById(e,{commentText:o.commentText}).success(function(e){n.modal.close(e)}).error(function(e){console.log("Error!");n.formError="Your comment has not been saved, try again"});return false};n.modal={close:function(t){e.close(t)},cancel:function(){e.dismiss("cancel")}}}})();(function(){angular.module("townReportApp").controller("stateChangeModalCtrl",e);e.$inject=["$uibModalInstance","trData","problemData"];function e(e,t,o){var n=this;n.problemData=o;n.stateOptions=[{name:"Rejected",active:false},{name:"New",active:false},{name:"Pending",active:false},{name:"Work in progress",active:false},{name:"Fixed",active:false}];n.onSubmit=function(){n.formError="";if(!n.formData||!n.formData.state||!n.formData.commentText){n.formError="All fields required, please try again";return false}else{n.doAddStateChange(n.problemData.problemid,n.formData)}};n.doAddStateChange=function(e,o){t.addStateChangeById(e,{state:o.state.name,commentText:o.commentText}).success(function(e){n.modal.close(e)}).error(function(e){console.log("Error!");n.formError="State change has not been saved, try again"});return false};n.modal={close:function(t){e.close(t)},cancel:function(){e.dismiss("cancel")}};n.setStateOptions=function(e){var t=["Rejected","New","Pending","Work in progress","Fixed"];var o=t.indexOf(e);if(o===0){n.stateOptions[1].active=true}else if(o===n.stateOptions.length){n.stateOptions[n.stateOptions.length-2].active=true}else{n.stateOptions[o-1].active=true;n.stateOptions[o+1].active=true}};n.setStateOptions(n.problemData.problemState)}})();(function(){angular.module("townReportApp").controller("registerModalCtrl",e);e.$inject=["$rootScope","$uibModalInstance","$location","authentication"];function e(e,t,o,n){var r=this;r.pageHeader={title:"Create a new TownReport account"};r.credentials={name:"",email:"",password:"",password2:""};r.returnPage=o.search().page||"/";r.onSubmit=function(){r.formError="";if(!r.credentials.name||!r.credentials.email||!r.credentials.password||!r.credentials.password2){r.formError="All fields required, please try again";return false}else if(r.credentials.password!==r.credentials.password2){r.formError="Passwords must be the same, please try again";return false}else{r.doRegister()}};r.doRegister=function(){r.formError="";n.register(r.credentials).error(function(e){r.formError=e.message}).then(function(){r.modal.close()});return false};r.modal={close:function(o){t.close(o);if(o==="login"){e.$broadcast("loginRequest","registerModal")}},cancel:function(){t.dismiss("cancel")}}}})();(function(){angular.module("townReportApp").controller("loginModalCtrl",e);e.$inject=["$rootScope","$uibModalInstance","$location","authentication"];function e(e,t,o,n){var r=this;r.pageHeader={title:"User Login"};r.credentials={email:"",password:""};r.returnPage=o.search().page||"/";r.onSubmit=function(){r.formError="";if(!r.credentials.email||!r.credentials.password){r.formError="All fields required, please try again";return false}else{r.doLogin()}};r.doLogin=function(){r.formError="";n.login(r.credentials).error(function(e){r.formError=e.message}).then(function(){r.modal.close()});return false};r.modal={close:function(o){t.close(o);if(o==="register"){e.$broadcast("registerRequest","loginModal")}},cancel:function(){t.dismiss("cancel")}}}})();(function(){angular.module("townReportApp").service("geolocation",e);function e(){var e=function(e,t,o){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(e,t)}else{o()}};return{getPosition:e}}})();(function(){angular.module("townReportApp").service("trData",e);e.$inject=["$http","authentication"];function e(e,t){var o=function(t,o){return e.get("/api/problems?lng="+o+"&lat="+t+"&maxDistance=10")};var n=function(){return e.get("/api/problems/all")};var r=function(t){return e.get("/api/problems/"+t)};var a=function(o){return e.post("/api/problems/",o,{headers:{Authorization:"Bearer "+t.getToken()}})};var i=function(o,n){return e.put("/api/problems/"+o,n,{headers:{Authorization:"Bearer "+t.getToken()}})};var l=function(o,n){return e.post("/api/problems/"+o+"/comments",n,{headers:{Authorization:"Bearer "+t.getToken()}})};var s=function(o,n){return e.post("/api/problems/"+o+"/statechanges",n,{headers:{Authorization:"Bearer "+t.getToken()}})};var c=function(t){return e.post("/api/config",data)};return{problemsByCoords:o,problemsAll:n,problemById:r,addNewProblem:a,updateProblem:i,addCommentById:l,addStateChangeById:s,getVarValue:c}}})();(function(){angular.module("townReportApp").service("authentication",e);e.$inject=["$http","$window"];function e(e,t){var o=function(e){t.localStorage["townreport-token"]=e};var n=function(){return t.localStorage["townreport-token"]};var r=function(){var e=n();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return o.exp>Date.now()/1e3}else{return false}};var a=function(){if(r()){var e=n();var o=JSON.parse(t.atob(e.split(".")[1]));return o.admin}};var i=function(){if(r()){var e=n();var o=JSON.parse(t.atob(e.split(".")[1]));return{email:o.email,name:o.name,admin:o.admin}}};var l=function(t){return e.post("/api/register",t).success(function(e){o(e.token)})};var s=function(t){return e.post("/api/login",t).success(function(e){o(e.token)})};var c=function(){t.localStorage.removeItem("townreport-token")};return{saveToken:o,getToken:n,isLoggedIn:r,isAdmin:a,currentUser:i,register:l,login:s,logout:c}}})();(function(){angular.module("townReportApp").filter("formatDistance",t);var e=function(e){return!isNaN(parseFloat(e))&&isFinite(e)};function t(){return function(t){var o,n;if(t&&e(t)){if(t>1){o=parseFloat(t).toFixed(1);n="km"}else{o=parseInt(t*1e3,10);n="m"}return o+n}else{return"?"}}}})();(function(){angular.module("townReportApp").filter("addHtmlLineBreaks",e);function e(){return function(e){var t=e.replace(/\n/g,"<br/>");return t}}})();(function(){angular.module("townReportApp").filter("customSearch",e);function e(){return function(e,t){var o=[];if(!e)return;if(typeof t===undefined||t==="")return e;var n=new RegExp(t,"i");for(var r=0;r<e.length;r++){var a=e[r];if(n.test(a.name)||n.test(a.category)||n.test(a.state)||n.test(a.description)||n.test(a.address)||n.test(a.author)){o.push(a)}}return o}}})();(function(){angular.module("townReportApp").directive("priorityMarks",e);function e(){return{restrict:"EA",scope:{thisPriority:"=priority"},templateUrl:"/common/directives/priorityMarks/priorityMarks.template.html"}}})();(function(){angular.module("townReportApp").directive("footerGeneric",e);function e(){return{restrict:"EA",templateUrl:"/common/directives/footerGeneric/footerGeneric.template.html"}}})();(function(){angular.module("townReportApp").directive("navigation",e);function e(){return{restrict:"EA",templateUrl:"/common/directives/navigation/navigation.template.html",controller:"navigationCtrl as navvm"}}})();(function(){angular.module("townReportApp").controller("navigationCtrl",e);e.$inject=["$rootScope","$scope","$location","$uibModal","authentication"];function e(e,t,o,n,r){var a=this;a.currentPath=o.path();a.isLoggedIn=r.isLoggedIn();a.isAdmin=r.isAdmin();a.currentUser=r.currentUser();a.logout=function(){r.logout();o.path("/");e.$broadcast("login","logout")};t.$on("login",function(e){console.log("login navbar",e);a.isLoggedIn=r.isLoggedIn();a.isAdmin=r.isAdmin();a.currentUser=r.currentUser()});t.$on("loginRequest",function(e){console.log("loginRequest",e);a.popupLoginForm()});a.popupLoginForm=function(){var t=n.open({templateUrl:"auth/loginModal/loginModal.view.html",controller:"loginModalCtrl as vm"});t.result.then(function(t){e.$broadcast("login","login")})};t.$on("registerRequest",function(e){console.log("registerRequest",e);a.popupRegisterForm()});a.popupRegisterForm=function(){var t=n.open({templateUrl:"auth/registerModal/registerModal.view.html",controller:"registerModalCtrl as vm"});t.result.then(function(t){e.$broadcast("login","login")})}}})();(function(){angular.module("townReportApp").directive("pageHeader",e);function e(){return{restrict:"EA",scope:{content:"=content"},templateUrl:"/common/directives/pageHeader/pageHeader.template.html"}}})();